{% extends "base.html" %}

{% block title %}Player Dashboard - Physical Testing{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="mb-2">
                <i class="fas fa-dumbbell me-3"></i>
                Physical Testing Dashboard
            </h1>
            <p class="mb-0">Welcome back, {{ user.player_name or user.username }}! Track your physical performance metrics.</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="d-flex align-items-center justify-content-end">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='BostonBoltsLogo.png') }}" alt="Boston Bolts" style="height: 50px; width: auto;">
                    <div class="logo-divider"></div>
                    <img src="{{ url_for('static', filename='MLSNextLogo.png') }}" alt="MLS Next" style="height: 50px; width: auto;">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading State -->
<div id="loading-state" class="text-center py-5">
    <div class="loading mb-3"></div>
    <p class="text-white">Loading your physical testing data...</p>
</div>

<!-- Error State -->
<div id="error-state" class="alert alert-danger" style="display: none;">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <span id="error-message"></span>
</div>

<!-- Main Dashboard Content -->
<div id="dashboard-content" style="display: none;">
    <!-- Player Info -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-user me-2"></i>Player Information
                    </h5>
                    <div class="row">
                        <div class="col-6">
                            <p class="mb-1"><strong>Name:</strong></p>
                            <p class="mb-1"><strong>Team:</strong></p>
                            <p class="mb-0"><strong>Last Updated:</strong></p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1" id="player-name">-</p>
                            <p class="mb-1" id="player-team">-</p>
                            <p class="mb-0" id="last-updated">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-line me-2"></i>Performance Summary
                    </h5>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="overall-progress">-</div>
                            <div class="stat-label">Overall Progress</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="tests-improved">-</div>
                            <div class="stat-label">Tests Improved</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Physical Testing Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="fas fa-running me-2"></i>Physical Testing Metrics
            </h4>
        </div>
        <div class="card-body">
            <div class="row" id="physical-metrics">
                <!-- Metrics will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Physical Testing Charts -->
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>Performance Charts
            </h4>
        </div>
        <div class="card-body">
            <div class="row" id="physical-charts">
                <!-- Charts will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Progress Tracking -->
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="fas fa-trending-up me-2"></i>Progress Tracking
            </h4>
        </div>
        <div class="card-body">
            <div class="row" id="progress-charts">
                <!-- Progress charts will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadPhysicalData();
});

function loadPhysicalData() {
    fetch('/api/physical_data')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                displayPhysicalDashboard(data);
            }
        })
        .catch(error => {
            showError('Failed to load physical data: ' + error.message);
        });
}

function showError(message) {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('error-state').style.display = 'block';
    document.getElementById('error-message').textContent = message;
}

function displayPhysicalDashboard(data) {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('dashboard-content').style.display = 'block';
    
    // Update player info
    document.getElementById('player-name').textContent = '{{ user.player_name or user.username }}';
    document.getElementById('player-team').textContent = '{{ user.team or "Not assigned" }}';
    document.getElementById('last-updated').textContent = new Date().toLocaleDateString();
    
    // Calculate overall progress
    const physicalData = data.physical_data;
    let improvedTests = 0;
    let totalTests = Object.keys(physicalData).length;
    
    Object.values(physicalData).forEach(test => {
        if (test.trend === 'up') improvedTests++;
    });
    
    const overallProgress = Math.round((improvedTests / totalTests) * 100);
    
    document.getElementById('overall-progress').textContent = overallProgress + '%';
    document.getElementById('tests-improved').textContent = improvedTests + '/' + totalTests;
    
    // Display physical metrics
    displayPhysicalMetrics(physicalData);
    
    // Display charts
    displayPhysicalCharts(data.charts);
    
    // Display progress charts
    displayProgressCharts(data.progress_charts);
}

function displayPhysicalMetrics(physicalData) {
    const container = document.getElementById('physical-metrics');
    container.innerHTML = '';
    
    const testConfigs = {
        'broad_jump': { icon: 'fas fa-long-arrow-alt-right', color: 'primary' },
        'sprint_test': { icon: 'fas fa-running', color: 'success' },
        'agility_test': { icon: 'fas fa-route', color: 'warning' },
        'pull_ups': { icon: 'fas fa-dumbbell', color: 'info' },
        'yoyo_ir_level': { icon: 'fas fa-heartbeat', color: 'danger' },
        'vo2_max': { icon: 'fas fa-lungs', color: 'secondary' }
    };
    
    Object.entries(physicalData).forEach(([testName, data]) => {
        const config = testConfigs[testName] || { icon: 'fas fa-chart-line', color: 'primary' };
        const trendIcon = data.trend === 'up' ? 'fas fa-arrow-up text-success' : 'fas fa-arrow-down text-danger';
        
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 mb-3';
        
        col.innerHTML = `
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="${config.icon} fa-2x text-${config.color}"></i>
                    </div>
                    <h6 class="card-title">${testName.replace('_', ' ').toUpperCase()}</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Current</small>
                            <div class="h5 mb-0">${data.current} ${data.unit}</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Target</small>
                            <div class="h5 mb-0">${data.target} ${data.unit}</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Trend</small>
                            <div class="h5 mb-0"><i class="${trendIcon}"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(col);
    });
}

function displayPhysicalCharts(charts) {
    const container = document.getElementById('physical-charts');
    container.innerHTML = '';
    
    Object.entries(charts).forEach(([testName, chartData]) => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 mb-4';
        
        col.innerHTML = `
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title text-center">${testName.replace('_', ' ').toUpperCase()}</h6>
                    <div id="chart-${testName}"></div>
                </div>
            </div>
        `;
        
        container.appendChild(col);
        
        // Render the chart
        setTimeout(() => {
            Plotly.newPlot(`chart-${testName}`, 
                JSON.parse(chartData).data, 
                JSON.parse(chartData).layout);
        }, 100);
    });
}

function displayProgressCharts(progressCharts) {
    const container = document.getElementById('progress-charts');
    container.innerHTML = '';
    
    Object.entries(progressCharts).forEach(([testName, chartData]) => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 mb-4';
        
        col.innerHTML = `
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title text-center">${testName.replace('_', ' ').toUpperCase()} Progress</h6>
                    <div id="progress-chart-${testName}"></div>
                </div>
            </div>
        `;
        
        container.appendChild(col);
        
        // Render the progress chart
        setTimeout(() => {
            Plotly.newPlot(`progress-chart-${testName}`, 
                JSON.parse(chartData).data, 
                JSON.parse(chartData).layout);
        }, 100);
    });
}
</script>
{% endblock %} 